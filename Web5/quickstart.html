<style>

body {
  margin: 0;
  font-family: sans-serif;
}

body > progress {
  position: fixed;
  inset: 0;
  display: block;
  width: 50vw;
  margin: calc(50vh - 0.5em) 25vw;
}

body > progress ~ * {
  display: none;
}

main {
  max-width: 500px;
  margin: 0 auto;
  padding: 1em 2em 5em;
}

main h1 {
  text-align: center;
}

main progress {
  vertical-align: middle;
  visibility: hidden;
}

main input[type="file"] {
  display: block;
  margin-bottom: 0.5em;
}

main textarea {
  display: block;
  width: 100%;
  min-height: 8em;
  font-family: monospace;
  resize: vertical;
}

main code {
  font-size: 90%;
}

main .output {
  width: 100%;
  margin-top: 1em;
}

</style>

<progress></progress>
<main>
  <h1>Web5</h1>
  <section id="did-create">
    <h1>Create a Decentralized Identifier</h1>
    <div class="input">
      <pre><code>let did = await web5.did.create('ion');</code></pre>
      <button>Run!</button>
    </div>
    <div class="output">
      <details>
        <summary>
          <code>...</code>
        </summary>
        <textarea></textarea>
      </details>
    </div>
  </section>
  <section id="did-register">
    <h1>Register a Decentralized Identifier</h1>
    <div class="input">
      <pre><code>await web5.did.register({
  connected: true,
  did: did.id,
  endpoint: 'app://dwn',
  keys: did.keys[0].keypair,
});</code></pre>
      <button disabled>Run!</button>
    </div>
    <div class="output"></div>
  </section>
  <section id="dwn-write">
    <h1>Write some data</h1>
    <div class="input">
      <pre><code>let writeResult = await web5.dwn.records.write(did.id, {
  author: did.id,
  data,
  message: {
    dataFormat: 'image/png',
  },
});</code></pre>
      <input type="file" accept="image/png" disabled>
      <button disabled>Run!</button>
      <progress></progress>
    </div>
    <div class="output">
      <details>
        <summary>...</summary>
        <textarea readonly></textarea>
      </details>
    </div>
  </section>
  <section id="dwn-query">
    <h1>Query for messages</h1>
    <div class="input">
      <pre><code>let queryResult = await web5.dwn.records.query(did.id, {
  author: did.id,
  message: {
    filter: {
      dataFormat: 'image/png',
    },
  },
});</code></pre>
      <button disabled>Run!</button>
      <progress></progress>
    </div>
    <div class="output">
      <details>
        <summary>...</summary>
        <textarea readonly></textarea>
      </details>
    </div>
  </section>
  <section id="dwn-read">
    <h1>Read the data</h1>
    <div class="input">
      <pre><code>let readResult = await web5.dwn.records.read(did.id, {
  author: did.id,
  message: {
    recordId,
  },
});</code></pre>
      <button disabled>Run!</button>
      <progress></progress>
    </div>
    <div class="output"></div>
  </section>
  <section id="dwn-delete">
    <h1>Delete the messages</h1>
    <div class="input">
      <pre><code>let deleteResult = await web5.dwn.records.delete(did.id, {
  author: did.id,
  message: {
    recordId,
  },
});</code></pre>
      <button disabled>Run!</button>
      <progress></progress>
    </div>
    <div class="output">
      <details>
        <summary>...</summary>
        <textarea readonly></textarea>
      </details>
    </div>
  </section>
</main>

<script type="module">

/* ========================== */
/* ========== Web5 ========== */

import { Web5 } from 'https://cdn.jsdelivr.net/npm/@tbd54566975/web5@0.4.0-unstable.e6470ce-2023.4.01-19-39-11/dist/browser.mjs';

let web5 = new Web5;

async function didCreate() {
  let did = await web5.did.create('ion');
  return did;
};

async function didRegister(did) {
  await web5.did.register({
    connected: true,
    did: did.id,
    endpoint: 'app://dwn',
    keys: did.keys[0].keypair,
  });
};

async function dwnWritePNGRecord(did, data) {
  let result = await web5.dwn.records.write(did.id, {
    author: did.id,
    data,
    message: {
      dataFormat: 'image/png',
    },
  });
  return result;
}

async function dwnQueryPNGRecords(did) {
  let result = await web5.dwn.records.query(did.id, {
    author: did.id,
    message: {
      filter: {
        dataFormat: 'image/png',
      },
    },
  });
  return result;
}

async function dwnReadDataFromRecordWithId(did, recordId) {
  let result = await web5.dwn.records.read(did.id, {
    author: did.id,
    message: {
      recordId,
    },
  });
  return result;
}

async function dwnDeleteRecordWithId(did, recordId) {
  let result = await web5.dwn.records.delete(did.id, {
    author: did.id,
    message: {
      recordId,
    },
  });
  return result;
}

/* ========== Web5 ========== */
/* ========================== */



document.querySelector('progress').remove();

let didCreateInputButton = document.querySelector('#did-create .input button');
let didCreateOutputSummaryCode = document.querySelector('#did-create .output details summary code');
let didCreateOutputDetailsTextarea = document.querySelector('#did-create .output details textarea');

let didRegisterInputButton = document.querySelector('#did-register .input button');
let didRegisterOutput = document.querySelector('#did-register .output');

let dwnWriteInputFile = document.querySelector('#dwn-write .input input[type="file"]');
let dwnWriteInputButton = document.querySelector('#dwn-write .input button');
let dwnWriteInputProgress = document.querySelector('#dwn-write .input progress');
let dwnWriteOutputSummary = document.querySelector('#dwn-write .output details summary');
let dwnWriteOutputDetailsTextarea = document.querySelector('#dwn-write .output details textarea');

let dwnQueryInputButton = document.querySelector('#dwn-query .input button');
let dwnQueryInputProgress = document.querySelector('#dwn-query .input progress');
let dwnQueryOutputSummary = document.querySelector('#dwn-query .output details summary');
let dwnQueryOutputDetailsTextarea = document.querySelector('#dwn-query .output details textarea');

let dwnReadInputButton = document.querySelector('#dwn-read .input button');
let dwnReadInputProgress = document.querySelector('#dwn-read .input progress');
let dwnReadOutput = document.querySelector('#dwn-read .output');

let dwnDeleteInputButton = document.querySelector('#dwn-delete .input button');
let dwnDeleteInputProgress = document.querySelector('#dwn-delete .input progress');
let dwnDeleteOutputSummary = document.querySelector('#dwn-delete .output details summary');
let dwnDeleteOutputDetailsTextarea = document.querySelector('#dwn-delete .output details textarea');

function parseDid() {
  try {
    return JSON.parse(didCreateOutputDetailsTextarea.value);
  } catch {
    return undefined;
  }
}

function parseQuery() {
  try {
    return JSON.parse(dwnQueryOutputDetailsTextarea.value);
  } catch {
    return undefined;
  }
}

function update() {
  if (!parseDid()) {
    didRegisterInputButton.disabled = true;
    didRegisterOutput.innerHTML = '';
  }

  if (!didRegisterOutput.innerHTML) {
    dwnWriteInputFile.disabled = true;
    dwnWriteInputButton.disabled = true;
    dwnWriteInputProgress.style.visibility = 'hidden';
    dwnWriteOutputSummary.innerHTML = '...';
    dwnWriteOutputDetailsTextarea.value = '';

    dwnQueryInputButton.disabled = true;
    dwnQueryInputProgress.style.visibility = 'hidden';
    dwnQueryOutputSummary.innerHTML = '...';
    dwnQueryOutputDetailsTextarea.value = '';
  }

  if (!parseQuery()?.entries?.length) {
    dwnReadInputButton.disabled = true;
    dwnReadInputProgress.style.visibility = 'hidden';
    dwnReadOutput.innerHTML = '';

    dwnDeleteInputButton.disabled = true;
    dwnDeleteInputProgress.style.visibility = 'hidden';
    dwnDeleteOutputSummary.innerHTML = '...';
    dwnDeleteOutputDetailsTextarea.value = '';
  }
}

didCreateInputButton.addEventListener('click', async () => {
  let did = await didCreate();

  didCreateOutputSummaryCode.innerHTML = did.internalId;
  didCreateOutputDetailsTextarea.value = JSON.stringify(did, null, 2);

  didRegisterInputButton.disabled = false;
  didRegisterOutput.innerHTML = '';
  update();
});
didCreateOutputDetailsTextarea.addEventListener('input', () => {
  didCreateOutputSummaryCode.innerHTML = parseDid()?.internalId ?? '...';

  didRegisterInputButton.disabled = false;
  didRegisterOutput.innerHTML = '';
  update();
});

didRegisterInputButton.addEventListener('click', async () => {
  didRegisterInputButton.disabled = true;

  let did = parseDid();
  await didRegister(did);

  didRegisterOutput.innerHTML = '&#x2714; Registered!';

  dwnWriteInputFile.disabled = false;
  dwnQueryInputButton.disabled = false;
  update();
});

dwnWriteInputFile.addEventListener('input', () => {
  dwnWriteInputButton.disabled = false;
  dwnWriteOutputSummary.innerHTML = '...';
  dwnWriteOutputDetailsTextarea.value = '';
  update();
});

dwnWriteInputButton.addEventListener('click', async () => {
  dwnWriteInputButton.disabled = true;
  dwnWriteInputProgress.style.visibility = 'visible';

  dwnWriteOutputSummary.innerHTML = '...';

  let did = parseDid();
  for (let file of dwnWriteInputFile.files) {
    let buffer = await file.arrayBuffer();
    let data = new Uint8Array(buffer);
    let result = await dwnWritePNGRecord(did, data);

    dwnWriteOutputDetailsTextarea.value += JSON.stringify(result, null, 2) + '\n';
  }
  dwnWriteOutputDetailsTextarea.scrollTop = dwnWriteOutputDetailsTextarea.scrollHeight;

  dwnWriteOutputSummary.innerHTML = '&#x2714; Written!';

  dwnWriteInputButton.disabled = false;
  dwnWriteInputProgress.style.visibility = 'hidden';
  dwnQueryInputButton.disabled = false;
  update();
});

dwnQueryInputButton.addEventListener('click', async () => {
  dwnQueryInputButton.disabled = true;
  dwnQueryInputProgress.style.visibility = 'visible';

  dwnQueryOutputSummary.innerHTML = '...';
  dwnQueryOutputDetailsTextarea.value = '';

  let did = parseDid();
  let result = await dwnQueryPNGRecords(did);

  dwnQueryOutputSummary.innerHTML = `&#x2714; Found ${result.entries?.length ?? 0} entries!`;
  dwnQueryOutputDetailsTextarea.value = JSON.stringify(result, (key, value) => key !== 'encodedData' ? value : undefined, 2);

  dwnQueryInputButton.disabled = false;
  dwnQueryInputProgress.style.visibility = 'hidden';
  dwnReadInputButton.disabled = false;
  dwnDeleteInputButton.disabled = false;
  update();
});

dwnReadInputButton.addEventListener('click', async () => {
  dwnReadInputButton.disabled = true;
  dwnReadInputProgress.style.visibility = 'visible';

  dwnReadOutput.innerHTML = '';

  let did = parseDid();
  let query = parseQuery();
  for (let { recordId } of query.entries) {
    let result = await dwnReadDataFromRecordWithId(did, recordId);
    let data = await web5.dwn.SDK.DataStream.toBytes(result.data);

    let img = dwnReadOutput.appendChild(document.createElement('img'));
    img.src = URL.createObjectURL(new Blob([ data ]));
  }

  dwnReadInputButton.disabled = false;
  dwnReadInputProgress.style.visibility = 'hidden';
  update();
});

dwnDeleteInputButton.addEventListener('click', async () => {
  dwnDeleteInputButton.disabled = true;
  dwnDeleteInputProgress.style.visibility = 'visible';

  dwnDeleteOutputSummary.innerHTML = '...';

  let did = parseDid();
  let query = parseQuery();
  for (let { recordId } of query.entries) {
    let result = await dwnDeleteRecordWithId(did, recordId);
    dwnDeleteOutputDetailsTextarea.value += JSON.stringify(result, null, 2) + '\n';
  }
  dwnDeleteOutputDetailsTextarea.scrollTop = dwnDeleteOutputDetailsTextarea.scrollHeight;

  dwnDeleteOutputSummary.innerHTML = `&#x2714; Deleted ${query.entries.length} entries!`;

  dwnReadInputButton.disabled = true;
  dwnDeleteInputProgress.style.visibility = 'hidden';
  update();
});

</script>
